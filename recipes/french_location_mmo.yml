recipes:
  french_location_mmo:
    input: mmo
    steps:
       # lieu de naissance
       - exec:
          - df['matchid_location_countrycode'] = np.where(df['dep_naissance_sngi'] == "99", df['commune_naissance_sngi'], "FRANCE")
          - df['matchid_location_country'] = np.where(df['dep_naissance_sngi'] == "99", df['commune_naissance_sngi'], "FRANCE")
          - df['matchid_location_city'] = np.where(df['dep_naissance_sngi'] == "99", "", df['commune_naissance_sngi'])
       
       - replace:
          select: matchid_location_countrycode
          regex: 
            - '^((?!FRANCE).)*$': 'XXX'
            - 'FRANCE': 'FRA'
       - map:
           matchid_location_city_norm: matchid_location_city
           matchid_location_depcode: dep_naissance_sngi
       - normalize: 
           select: matchid_location_city_norm
       - french_city_norm:
       - join:
           type : in_memory
           dataset: french_citycodes_fuzzy
           fuzzy: # utile uniquement si données mmo peu fiable, double le temps de préparation résiduel (+2s / 10.000)
             matchid_location_city_norm: norm_name
           strict: 
             # matchid_location_city_norm: norm_name # alternative : match strict, permet de diviser par deux, et récupérer
             # # l'historique des communes. dans ce cas, il est préférable de faire cette opération post-matching
             matchid_location_depcode: dep_code
             matchid_location_countrycode: CODEISO3
           select: 
             matchid_location_citycode: insee_code
             matchid_location_citycode_history: insee_code_history
             matchid_location_city: name
             matchid_location_city_alter: newest_name
             matchid_location_city_population: population
             matchid_location_city_surface: surface
             matchid_location_city_geopoint_2d: geopoint_2d
       # - exec: # race intermédiaire pour évaluer si le fuzzy permet d'améliorer le match
       #     df['matchid_location_city_diff']= np.where(df['matchid_location_city_norm'] == df['matchid_location_city_norm_match'], "", df['matchid_location_city_norm'] + '<>' + df['matchid_location_city_norm_match'])
       - delete:
           select: matchid_location_city_norm.*
           
                  